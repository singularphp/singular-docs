<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Backend - Singular Framework</title>
      
      
      
        <link rel="canonical" href="http://singular.neton.com.br/conceitos/backend/">
      
      
        <meta name="author" content="Otávio Fernandes">
      
    
    <meta property="og:url" content="http://singular.neton.com.br/conceitos/backend/">
    <meta property="og:title" content="Singular Framework">
    <meta property="og:image" content="http://singular.neton.com.br/conceitos/backend//../../images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Singular Framework">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
      <link rel="apple-touch-icon" href="../../images/logo.png">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-b64b728552.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/palettes-05ab2406df.css">
    
    
      
      
      
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class="palette-primary-deep-orange ">
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Conceitos básicos <i class="icon icon-link"></i>
              
            
          </span>
        
        Backend
      </div>
    </div>
    
    
      
      <div class="button button-github" role="button" aria-label="GitHub">
        <a href="https://github.com/singularphp" title="@singularphp on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
      </div>
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Procurar" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Procurar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="../../images/logo.png">
        </div>
      
      <div class="name">
        <strong>Singular Framework 2.0</strong>
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Começando" href="../..">
      Começando
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Conceitos básicos</span>
    <ul>
      
        
  <li>
    <a class="" title="Ciclo de vida" href="../ciclo/">
      Ciclo de vida
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Singular Cli" href="../singularcli/">
      Singular Cli
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="Backend" href="./">
      Backend
    </a>
    
      
      
        <ul>
          
            <li class="anchor">
              <a title="Pacotes" href="#pacotes">
                Pacotes
              </a>
            </li>
          
            <li class="anchor">
              <a title="Comandos" href="#comandos">
                Comandos
              </a>
            </li>
          
            <li class="anchor">
              <a title="Controladores" href="#controladores">
                Controladores
              </a>
            </li>
          
            <li class="anchor">
              <a title="Serviços" href="#servicos">
                Serviços
              </a>
            </li>
          
            <li class="anchor">
              <a title="Stores" href="#stores">
                Stores
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
        
  <li>
    <a class="" title="Frontend" href="../frontend/">
      Frontend
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Como fazer" href="../../comofazer/">
      Como fazer
    </a>
    
  </li>

          
        </ul>
        
          <hr>
          <span class="section">Autor</span>
          <ul>
            
            
              
              <li>
                <a href="https://github.com/singularphp" target="_blank" title="@singularphp on GitHub">
                  @singularphp no GitHub
                </a>
              </li>
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
            <h1>Backend</h1>
          
          <p>No backend é onde é realizado todo o processamento da lógica de negócio, acesso à base de dados, geração de relatórios, 
envios de email, e outras tarefas semelhantes. Como mencionado anteriormente, o Singular Framework foi construído sobre 
o Silex, mas de forma totalmente orientada a objetos. </p>
<p>Todo o código backend de um projeto no Singular reside dentro do diretório <destak>src</destak>. </p>
<hr />
<h2 id="pacotes">Pacotes<a class="headerlink" href="#pacotes" title="Permanent link">#</a></h2>
<p>Cada conjunto de funcionalidades é organizado dentro de um pacote no diretório src. Por exemplo, se o sistema a ser 
desenvolvido possui um conjunto de funcionalidades relacionadas a cadastros, poderá ser criado um pacote <destak>Cadastro</destak> 
que irá armazenar todas as classes relacionadas a essa funcionalidade de cadastro. </p>
<p>Quando um novo projeto é criado com o Singular Project, já existe um pacote chamado <destak>Sessao</destak>. Esse pacote
possui controladores, serviços e stores relacionados às funcionalidades de controle de acesso e gerenciamento de sessão
da aplicação.</p>
<h3 id="estrutura-de-um-pacote">Estrutura de um Pacote<a class="headerlink" href="#estrutura-de-um-pacote" title="Permanent link">#</a></h3>
<p>Como dito anteriormente, um pacote é uma forma de agrupar um conjunto de funcionalidades relacionadas. 
Quando um pacote é criado, a seguinte estrutura de diretórios e arquivos é criada na raiz do diretório <destak>src</destak>:</p>
<ul>
<li><destak>Command</destak>: Diretório onde são armazenadas as classes das tarefas que serão adicionadas à linha de comando do singular para o pacote em questão;</li>
<li><destak>Controller</destak>: Diretório onde são armazenadas as classes dos controladores, controladores são o canal de comunicação entre o frontend e o backend. Funcionam como uma API do backend disponibilizada para acesso no frontend;</li>
<li><destak>Service</destak>: Diretório onde são armazenadas classes auxiliares que disponibilizam serviços para que o container de serviços do Silex possa disponibilizar para toda a aplicação;</li>
<li><destak>Store</destak>: Diretório onde são armazenadas as classes que intermediam a comunicação da aplicação com o banco de dados. Cada tabela é representada no Singular por um store;</li>
<li><destak>PacoteServiceProvider.php</destak>: Arquivo de definição do pacote, ele é que registra o provedor de serviços do pacote e o expõe para o container de serviços da aplicação.</li>
</ul>
<p>O Singular CLI possui tarefas utilitárias para a criação de todos os recursos de um pacote, mais adiante iremos estudá-lo para conhecer as tarefas disponíveis.</p>
<h3 id="criando-um-pacote">Criando um pacote<a class="headerlink" href="#criando-um-pacote" title="Permanent link">#</a></h3>
<p>A maneira mais fácil de criar um pacote é utilizar o Singular CLI, para isso, no terminal, no diretório raiz do seu projeto digite o seguinte comando:</p>
<pre class="code"><code class="language-shell">./singular backend:create-pack NomeDoPacote</code></pre>


<p>Onde, <destak>NomeDoPacote</destak>, deverá ser substituído pelo nome do pacote que você deseja criar.</p>
<p>Ao executar este comando, um novo diretório nomeado de acordo com nome que você forneceu ao pacote será criado na 
raiz do diretório src, com a estrutura completa de um pacote.</p>
<p>Além disso, um arquivo chamado <destak>nomedopacote.php</destak> é criado dentro do diretório <a href="">app/packs</a>. Ao abrir 
este arquivo, você pode verificar a seguinte declaração:</p>
<pre class="code"><code class="language-php">use NomeDoPacote\NomeDoPacoteServiceProvider;

$app-&gt;register(new NomeDoPacoteServiceProvider());</code></pre>


<p>Uma vez que o Singular é criado sobre o <destak>Silex Framework</destak>, ele também utiliza a funcionalidade de provedores
de serviço para extender suas funcionalidades. Neste caso, cada novo pacote criado é um novo provedor de serviços, e 
cada funcionalidade desse pacote extende as funcionalidades do framework.</p>
<h3 id="desabilitando-um-pacote">Desabilitando um pacote<a class="headerlink" href="#desabilitando-um-pacote" title="Permanent link">#</a></h3>
<p>Algumas vezes, pode ser necessário, para efeitos de testes ou por outro motivo, desativar um pacote e todas as suas 
funcionalidades. Para fazer isso, basta apagar o arquivo <a href="">app/packs/nomedopacote.php</a>. Mas isso pode ser feito via 
<destak>Singular Cli</destak></p>
<pre class="code"><code class="language-shell">./singular backend:disable-pack NomeDoPacote</code></pre>


<h3 id="habilitando-um-pacote">Habilitando um pacote<a class="headerlink" href="#habilitando-um-pacote" title="Permanent link">#</a></h3>
<p>Se um pacote foi desabilitado, ou criado manualmente, para que o mesmo seja novamente ativado, é necessário que ele seja
habilitado. Para isso, basta criar um arquivo chamado <destak>nomedopacote.php</destak> dentro do diretório <a href="">app/packs</a>. 
Dentro desse arquivo, você deve registrar o seu provedor de serviços.</p>
<pre class="code"><code class="language-php">use NomeDoPacote\NomeDoPacoteServiceProvider;

$app-&gt;register(new NomeDoPacoteServiceProvider());</code></pre>


<p>Entretanto, isso também pode ser alcançado de forma muito mais simples, através do <destak>Singular Cli</destak></p>
<pre class="code"><code class="language-shell">./singular backend:enable-pack NomeDoPacote</code></pre>


<hr />
<h2 id="comandos">Comandos<a class="headerlink" href="#comandos" title="Permanent link">#</a></h2>
<p>Comandos são tarefas que podem ser executadas pelo terminal através do Singular Cli. Comandos são úteis para disparar 
emails, executar tarefas de limpeza de tabelas, etc. Eles podem ser acionados manualmente, ou ser programados para 
executar automaticamente através de ferramentas como o <destak>cron</destak> do linux.</p>
<h3 id="criando-um-comando">Criando um comando<a class="headerlink" href="#criando-um-comando" title="Permanent link">#</a></h3>
<p>Cada pacote pode definir seus próprios comandos, e desta forma extender as funcionalidades do <destak>Singular Cli</destak>
para executar tarefas específicas do pacote. </p>
<p>Para criar um comando, basta digitar a seguinte instrução no seu terminal:</p>
<pre class="code"><code class="language-shell">./singular backend:create-command Comando Pacote</code></pre>


<div class="admonition onde">
<p class="admonition-title">Onde</p>
<p><span>Comando</span> deve ser substituído pelo nome script de comando<br>
<span>Pacote</span> deve ser substituído pelo nome do pacote onde você deseja armazenar o novo comando</p>
</div>
<p>Ao executar essa instrução, uma nova classe php, com o nome fornecido para o comando, será criado no diretório Command 
do seu pacote. </p>
<p>A estrutura dessa classe é bem simples, ela possui apenas 2 métodos <destak>configure</destak> e <destak>execute</destak>, 
conforme veremos em detalhe abaixo:</p>
<pre class="code"><code class="language-php"> 1.  class TesteCommandCommand extends Command
 2.  {
 6.      public function configure()
 7.      {
 8.         $this-&gt;setName('sessao:teste-command')
 9.             -&gt;setDescription('Descrição do comando')
10.            -&gt;setHelp('Ajuda para execução do comando')
11.            -&gt;addArgument(
12.                'parametro',
13.                InputArgument::REQUIRED,
14.                'Descricao do parâmetro'
15.            );
16.      }
17.
24.      public function execute(InputInterface $input, OutputInterface $output)
25.      {
26.          $app = $this-&gt;getSilexApplication();
27.
28.          $output-&gt;writeln(sprintf('&lt;info&gt;%s&lt;/info&gt;', 'Comando executado com sucesso!'));
29.      }
30.  }</code></pre>


<p>No método <destak>configure</destak> é feita a configuração do parâmetro: </p>
<div class="admonition entendendo">
<p class="admonition-title">Entendendo</p>
<p><span>Linha 8</span> É definido o nome do comando que será exibido no Singular Cli, 
é uma boa prática utilizar o nome do pacote como namespace de um comando 
Por exemplo, se o comando chama-se teste e o pacote cadastro, o nome deveria ser <span>cadastro:teste</span></p>
<p><span>Linha 9</span> É definido o texto de definição do comando, que exibe a ajuda ao usuário, sobre o que o 
comando faz</p>
<p><span>Linha 10</span> É definido um texto de ajuda, que será exibido quando o usuário digitar a opção de ajuda 
para o seu comando</p>
<p><span>Linha 11 a 14</span> São definidos os argumentos do comando, ou parâmetros, como costumamos chamá-los. 
Podem ser criados tantos argumentos quanto necessários. Argumentos são obrigatórios, mas existe opções, que são 
parâmetros opcionais </p>
</div>
<p>O método <destak>execute</destak> é acionado quando o seu comando é executado pelo Singular Cli, ele pode acessar 
qualquer serviço da sua aplicação para executar uma determinada tarefas. </p>
<p>Para maiores informações, acesse o site da documentação do <a href="http://symfony.com/doc/current/console.html">Componente Console do Symfony</a>.</p>
<h2 id="controladores">Controladores<a class="headerlink" href="#controladores" title="Permanent link">#</a></h2>
<p>Controladores são a interface de comunicação entre o frontend e o backend. Quando uma informação do backend é 
necessária no frontend, como por exemplo, uma lista de usuários, uma requisição é feita a partir da interface para um 
controlador, esse por sua vez, é responsável por realizar as chamadas aos serviços e stores e retornar essa informação 
para o frontend no formato json. </p>
<h3 id="criando-um-controlador">Criando um controlador<a class="headerlink" href="#criando-um-controlador" title="Permanent link">#</a></h3>
<p>Para criar um novo controlador através do Singular Cli, basta executar o seguinte código:</p>
<pre class="code"><code class="language-shell">./singular backend:create-controller Controlador Pacote</code></pre>


<div class="admonition onde">
<p class="admonition-title">Onde</p>
<p><span>Controlador</span> deve ser substituído pelo nome do controlador<br>
<span>Pacote</span> deve ser substituído pelo nome do pacote onde você deseja armazenar o novo controlador</p>
</div>
<p>Ao executar essa instrução, uma nova classe php, com o nome fornecido para o controlador, será criado no diretório 
<destak>Controller</destak> do seu pacote.  A estrutura básica da classe de um controlador se parece com:</p>
<pre class="code"><code class="language-php">1.  /**
2.   * Classe Perfil
3.   *
4.   * @Controller
5.   *
6.   * @author Otávio Fernandes &lt;otavio@netonsolucoes.com.br&gt;
7.   */
8.  class Perfil extends SingularController
9.  {
10.    use Crud;
11.
12.    /**
13.     * Defina o store padrão do controlador.
14.     *
15.     * @var $store
16.     */
17.    protected $store = 'perfil';
18. }</code></pre>


<p>O que diferencia uma classe de um controlador de uma outra classe qualquer é a anotação <destak>@Controller</destak> no 
bloco de documentação da classe. Se essa anotação não existir, não será possível acessar nenhum de seus métodos através 
do frontend.</p>
<p>Outro ponto importante, é que, se você desejar que o controlador criado já implemente métodos básicos de funcionalidades
 <destak>CRUD</destak>, você pode utilizar o <destak>Trait Crud</destak>, como é feito na <destak>linha 10</destak>. 
 Por padrão, um controlador criado pelo Singular Cli, já implementa esse traço, mas você pode retirar esse comportamento, 
 removendo o <destak>use Crud</destak> da declaração da classe. </p>
<div class="admonition crud">
<p class="admonition-title">Crud</p>
<ul>
<li>
<p><span>Método find</span> Função que recupera uma lista de registros vinculados há um store de acordo com parâmetros de 
filtro, paginação e ordenação (<span>filter</span>, <span>paging</span> e <span>sort</span>);</p>
</li>
<li>
<p><span>Método get</span> Função que recupera um registro específico vinculado há um store de acordo com o parâmetro 
<span>id</span> desse registro;</p>
</li>
<li>
<p><span>Método save</span> Função que cria/atualiza um registro específico vinculado há um store de acordo com 
parâmetros de campos de uma tabela. Se o campo <span>id</span> for enviado na lista de parâmetros o registro é 
atualizado, caso contrário, um novo registro é criado e o seu id é retornado para o método que fez a requisição no 
frontend;</p>
</li>
<li>
<p><span>Método remove</span> Função que exclui um registro vinculado há um store através do seu <span>id</span> 
informado como parâmetro.</p>
</li>
</ul>
</div>
<p>Outro ponto muito importante a considerar é a propriedade <destak>$store</destak> da classe do controlador. Essa 
propriedade faz referência direta a qual classe <destal>store</destak> o controlador está vinculado. Sem essa 
propriedade definida, nenhum método definido pelo traço <destak>Crud</destak> irá funcionar. Ela deve referenciar, 
no minúsculo, há uma classe store, criada no mesmo pacote do controlador. Caso não seja um controlador que use o 
traço Crud, ela não é necessária. </p>
<h3 id="expondo-metodos-para-o-frontend">Expondo métodos para o frontend<a class="headerlink" href="#expondo-metodos-para-o-frontend" title="Permanent link">#</a></h3>
<p>O objetivo de uma classe de controlador é fornecer um método que permita comunicação entre o backend e o frontend. Para 
 que isso aconteça é extremamente necessário que os métodos criados no controlador sejam <destak>expostos</destak> para o frontend. 
 Veja como um novo método pode ser criado e exposto para o frontend:</p>
<pre class="code"><code class="language-php">&lt;?php
1.  namespace Sessao\Controller;

2.  use Symfony\Component\HttpFoundation\Request;
3.  use Singular\SingularController;
4.  use Singular\Crud;
6.  use Singular\Annotation\Controller;
7.  use Singular\Annotation\Route;
8.  use Singular\Annotation\Direct;
9.  use Singular\Annotation\Value;
10. use Singular\Annotation\Assert;
11. use Singular\Annotation\Convert;
12. use Singular\Annotation\After;
13. use Singular\Annotation\Before;

14. /**
15.  * Classe Perfil
16.  *
17.  * @Controller
18.  *
19.  * @author Otávio Fernandes &lt;otavio@netonsolucoes.com.br&gt;
20.  */
21. class Perfil extends SingularController
22. {
23.     use Crud;
24.
25.     /**
26.      * Defina o store padrão do controlador.
27.      *
28.      * @var $store
29.      */
30.    protected $store = 'perfil';
31.
32.    /**
33.     * Emite uma saudação para um nome completo.
34.     *
35.     * @Route(method=&quot;post&quot;)
36.     *
37.     * @param Request $request
38.     *
40.     * @return \Singular\Response\JsonResponse
41.     */
42.    public function saudacoesNomeCompleto(Request $request)
43.    {
47.        $app = $this-&gt;app;
48.
49.        $primeiroNome = $request-&gt;get('primeiro_nome');
50.        $segundoNome = $request-&gt;get('segundo_nome');
51.
52.        return $app-&gt;json([
53.            'mensagem' =&gt; 'Olá '.$primeiroNome.' '.$segundoNome.', seja bem vindo!'
54.        ]);
58.    }
59. }</code></pre>


<p>O método <destak>saudacoesNomeCompleto</destak> do controlador <destak>Perfil</destak> do pacote <destak>Sessao</destak> 
precisa ser exposto para a camada de frontend. Para isso, utilizamos a anotação da <destak>linha 35</destak></p>
<pre class="code"><code class="language-php">@Route(method=&quot;post&quot;)</code></pre>


<p>Ao utilizarmos essa anotação, estamos tornando possível que uma requisição seja feita diretamente da interface por 
 exemplo através do serviço <destak>$http</destak> do <strong>AngularJS</strong> ou qualquer outro framework:</p>
<pre class="code"><code class="language-javascript">$http.post('./sessao/perfil/saudacoesNomeCompleto', {primeiro_nome: &quot;Otavio&quot;, segundo_nome: &quot;Fernandes&quot;}, function(response){
   alert(response.mensagem);
});</code></pre>


<p>Todos os métodos http estão disponíveis para serem utilizados na anotação <destak>@Route</destak> (get, post, put, 
delete, options). Algumas vezes, pode ser necessário expor uma função do controlador para mais de um método http, 
isso pode ser facilmente alcançado com:</p>
<pre class="code"><code class="language-php">@Route(methods={&quot;post&quot;,&quot;options&quot;})</code></pre>


<p>Por padrão, todos os parâmetros são recuperados na função do controlador através de um objeto da classe 
<destak>Symfony\Component\HttpFoundation\Request</destak> que é parâmetro da função. Entretanto, algumas vezes, 
você pode necessitar passar alguns parâmetros na própria URL, para isso basta adicionar o nome desses parâmetros na 
sua função:</p>
<pre class="code"><code class="language-php">    /**
     * Emite uma saudação para um nome completo.
     *
     * @Route(method=&quot;get&quot;)
     *
     * @param Request $request
     * @param string  $primeiroNome
     * @param string  $segundoNome
     *
     * @return \Singular\Response\JsonResponse
     */
    public function saudacoesNomeCompleto(Request $request, $primeiroNome, $segundoNome)
    {
        $app = $this-&gt;app;

        $primeiroNome = $primeiroNome;
        $segundoNome = $segundoNome;

        return $app-&gt;json([
            'mensagem' =&gt; 'Olá '.$primeiroNome.' '.$segundoNome.', seja bem vindo!'
        ]);
    }</code></pre>


<p>E a chamada http ficaria semelhante à:</p>
<pre class="code"><code class="language-javascript">$http.get('./sessao/perfil/saudacoesNomeCompleto/Otavio/Fernandes', function(response){
   alert(response.mensagem);
});</code></pre>


<h3 id="middlewares-de-controladores">Middlewares de controladores<a class="headerlink" href="#middlewares-de-controladores" title="Permanent link">#</a></h3>
<p>Assim como no Silex, o Singular permite que sejam definidos <destak>middlewares de rotas</destak> que podem ser 
executados antes, ou depois de um grupo de rotas ser executado. Cada controlador no Singular é mapeado para um grupo
de rota do Silex. Para criar middlares para um controlador, basta alterar a anotação <destak>@Controller</destak>, 
adicionando as anotações <destak>@After</destak> e <destak>@Before</destak>.</p>
<pre class="code"><code class="language-php">1.  /**
2.   * Classe Perfil
3.   *
4.   * @Controller(
5.   *      @Before({&quot;pacote.service.servico:metodoAntes&quot;})
6.   *      @After({&quot;pacote.service.servico:metodoDepois&quot;})
7.   * )
8.   *
9.   */
10.  class Perfil extends SingularController
11.  {
12.  }</code></pre>


<div class="admonition onde">
<p class="admonition-title">Onde</p>
<p><span>pacote</span> é o nome do pacote onde está o serviço que será executado como middleware<br>
<span>servico</span> é o nome da classe do serviço que será instanciado<br>
<span>metodoAntes</span> é o método na classe serviço, que será executado antes de qualquer método no controlador 
ser acionado<br>
<span>metodoDepois</span> é o método na classe serviço, que será executado depois todo método no controlador ser 
executado</p>
</div>
<p>No exemplo acima, estão sendo registrados dois middlewares <destak>@Before</destak> e <destak>@After</destak>. </p>
<p>Antes que qualquer método exposto do controlador <destak>Perfil</destak> seja executado o método <destak>metodoAntes</destak> 
da classe <destak>Pacote\Service\Servico</destak> será executado, como um interceptador da requisição, e poderá manipular 
o objeto <destak>Request</destak> adicionando ou removendo parâmetros, ou mesmo curto-circuitar a resposta, impedindo que 
o método do controlador seja executado.</p>
<p>Após a execução de qualquer método do controlador Perfil. o método <destak>metodoDepois</destak> da classe <destak>
Pacote\Service\Servico</destak> será executado e receberá como parâmetro o objeto <destak>Response</destak> retornado
pelo método do controlador.</p>
<p>Exemplo de implementação do serviço middleware.</p>
<pre class="code"><code class="language-php">1.  namespace Pacote\Service;
2.  
3.  class Servico
4.  {
5.      public function metodoAntes(Request $request)
6.      {
6.           $app = $this-&gt;app;
8.
9.           $request-&gt;set('user_id',$app['session']-&gt;get('user'));
10.     }
11.     
12.     public function metodoDepois(Request $request, Response $response)
13.     {
14.          $app = $this-&gt;app;
15.
16.          $response-&gt;set('user_id',$app['session']-&gt;get('user'));
17.     }
18.     </code></pre>


<hr />
<h2 id="servicos">Serviços<a class="headerlink" href="#servicos" title="Permanent link">#</a></h2>
<p>Serviços são classes que expõe métodos e funções utilitárias que permitem a execução de algumas lógicas e regras de negócio para outras partes da aplicação (outros serviços e controladores). </p>
<h3 id="criando-um-servico">Criando um Serviço<a class="headerlink" href="#criando-um-servico" title="Permanent link">#</a></h3>
<p>Para criar um serviço, basta utilizar o Singular Cli:</p>
<pre class="code"><code class="language-shell">./singular backend:create-service NomeServico Pacote</code></pre>


<div class="admonition onde">
<p class="admonition-title">Onde</p>
<p><span>NomeServico</span> deve ser substituído pelo nome do serviço que se deseja criar<br>
<span>Pacote</span> deve ser substituído pelo nome do pacote onde se deseja criar o novo serviço</p>
</div>
<p>Todo serviço tem acesso ao container da aplicação, que pode ser acessado através da propriedade $app do serviço. 
Pelo container da aplicação, você pode acessar qualquer outro serviço definido na aplicação. </p>
<p>Assim como com os controladores, um serviço no Singular Framework precisa ser anotado para estar registrado no container 
da aplicação como um serviço. Para isso, a anotação <destak>@Service</destak> deve ser utilizada. </p>
<h3 id="acessando-servicos-do-container">Acessando serviços do container<a class="headerlink" href="#acessando-servicos-do-container" title="Permanent link">#</a></h3>
<p>Frequentemente, faz-se necessário acessar serviços a partir de um controlador, ou mesmo de outro serviço. 
Entende-se por serviço, qualquer classe que estiver dentro de um pacote da aplicação. Suponha que você precise acessar 
um serviço chamado <destak>CalculoSalario</destak> que está definido dentro do pacote <destak>Financeiro</destak>, para
acessá-lo, basta pegar uma referência do container de serviços da aplicação, como é feito no pimple:</p>
<pre class="code"><code class="language-php">$servico = $this-&gt;app['cadastro.store.calculo_salario'];</code></pre>


<p>É possível acessar qualquer serviço criado, a partir de qualquer pacote, controlador ou serviço, simplesmente usando 
a anotação de namespace de serviços com três partes. Onde a primeira parte identifica o pacote, a segunda, o diretório 
do pacote (Command, Controller, Service, Store) e a terceira o nome da classe em <destak>snake_case</destak>.</p>
<h2 id="stores">Stores<a class="headerlink" href="#stores" title="Permanent link">#</a></h2>
<p>Classes Stores são a camada de acesso ao banco de dados da sua aplicação. Cada store, pode representar uma tabela, e 
disponibiliza uma API de métodos que estarão disponíveis para serviços e controladores que executam consultas e 
manipulações específicas no banco de dados retornando resultados, alterando ou manipulando registros.</p>
<h3 id="criando-um-store">Criando um Store<a class="headerlink" href="#criando-um-store" title="Permanent link">#</a></h3>
<p>Para criar um store, você pode utilizar o Singular Cli:</p>
<pre class="code"><code class="language-shell">./singular backend:create-store Store Pacote tabela</code></pre>


<div class="admonition onde">
<p class="admonition-title">Onde</p>
<p><destak>Store</destak> deve ser substituído pelo nome da classe do store<br>
<destak>Pacote</destak> deve ser substituído pelo nome do pacote onde você deseja armazenar o novo controlador<br>
<destak>tabela</destak> nome da tabela no banco de dados vinculada ao store</p>
</div>
<h3 id="metodos-do-store">Métodos do Store<a class="headerlink" href="#metodos-do-store" title="Permanent link">#</a></h3>
<p>Todo store, estende a classe <destak>Singular\SingularStore</destak>, com isso ela herda alguns métodos utilitários do 
da classe mãe:</p>
<div class="admonition note">
<p class="admonition-title">find($id: integer): array</p>
<p>O método find localiza um registro na tabela do banco de dados pelo seu <destak>id</destak>.</p>
<blockquote>
<p><strong>PARÂMETROS</strong>:<br>
<span>$id</span> Chave primária de localização do registro<br>
<strong>RETORNO</strong>:<br>
<span>array</span> representando um registro único da tabela</p>
</blockquote>
</div>
<p>Exemplo: </p>
<pre class="code"><code class="language-php">$usuario = $app['cadastro.store.usuario']-&gt;find(1);</code></pre>


<div class="admonition note">
<p class="admonition-title">findOneBy($filters: array):array</p>
<p>Localiza um registro de uma tabela através de um <span>array de filtros</span> aplicados nessa tabela. </p>
<blockquote>
<p><strong>PARÂMETROS</strong>: <br>
<span>$filters</span> array de filtros a serem aplicados na consulta<br>
<strong>RETORNO</strong>:<br> 
<span>array</span> representando um registro único da tabela.</p>
</blockquote>
</div>
<p>Exemplo: </p>
<pre class="code"><code class="language-php">$usuario = $app['cadastro.store.usuario']-&gt;findBy([
      'login' =&gt; '%:Otavio', 
      'email' =&gt; 'otavio@neton.com.br'
]);</code></pre>


<div class="admonition note">
<p class="admonition-title">findBy($filters: array, $pageOpts: array, $sort: array):array</p>
<p>Localiza um conjunto de registros que combinam com um grupo de filtros aplicado na tabela. </p>
<blockquote>
<p><strong>PARÂMETROS</strong>:<br>
<span>$filters</span> array de filtros a serem aplicados na consulta<br>
<span>$pageOpts</span> array de configuração da paginação dos resultados<br>
<span>$sort</span> array de configuração da ordenação dos resultados<br>
<strong>RETORNO</strong>: <br>
<span>array</span> de resultados representando 1 ou mais registros retornados pela consulta</p>
</blockquote>
</div>
<p>Exemplo: </p>
<pre class="code"><code class="language-php">$usuarios = $app['cadastro.store.usuario']-&gt;findBy(
     ['email' =&gt; '%:gmail.com'],
     ['start' =&gt; 0,'limit'=&gt; 5], 
     ['nome' =&gt; 'asc']
);</code></pre>


<div class="admonition note">
<p class="admonition-title">save($record:array):integer</p>
<p>Cria/atualiza um registro na tabela e retorna o seu <span>id</span></p>
<blockquote>
<p><strong>PARÂMETROS</strong>:<br>
<span>$record</span> array representando o registro a ser salvo na tabela<br>
<strong>RETORNO</strong>:<br>
<span>integer</span> id do registro inserido/atualizado na tabela.</p>
</blockquote>
</div>
<p>Exemplo:</p>
<pre class="code"><code class="language-php">$usuario = ['nome' =&gt; 'Otávio', 'login' =&gt; 'otavio', 'senha'=&gt; '123];
$id = $app['cadastro.store.usuario']-&gt;save($usuario);</code></pre>


<div class="admonition note">
<p class="admonition-title">remove($id: integer): boolean</p>
<p>Remove um registro da tabela através do seu <span>id</span></p>
<blockquote>
<p><strong>PARÂMETROS</strong>:<br>
<span>$id</span> inteiro representando o id do registro que se deseja remover<br>
<strong>RETORNO</strong>:<br>
<span>boolean</span> true se o registro foi excluído e false se não foi possível excluir o registro</p>
</blockquote>
</div>
<p>Exemplo:</p>
<pre class="code"><code class="language-php">$excluido = $app['cadastro.store.usuario']-&gt;remove(1);</code></pre>


<div class="admonition note">
<p class="admonition-title">removeBy($filter: array): boolean</p>
<p>Remove um ou mais registros da tabela através da combinação de filtros aplicados na tabela.</p>
<blockquote>
<p><strong>PARÂMETROS</strong>:<br>
<span>$filter</span> array de filtros a serem aplicados na consulta de exclusão<br>
<strong>RETORNO</strong>:<br>
<span>boolean</span> true se o registro foi excluído e false se não foi possível excluir o registro</p>
</blockquote>
</div>
<p>Exemplo:      </p>
<pre class="code"><code class="language-php">$excluido = $app['cadastro.store.usuario']-&gt;removeBy(['email' =&gt; '%:gmail.com']);</code></pre>


<h3 id="operadores-de-filtros">Operadores de filtros<a class="headerlink" href="#operadores-de-filtros" title="Permanent link">#</a></h3>
<p>Os métodos <destak>findOneBy</destak>, <destak>findBy</destak> e <destak>removeBy</destak> recebem como parâmetro uma
propriedade <destak>$filter</destak> que é um array de filtros a serem aplicados nas consultas.</p>
<p>Por padrão, um filtro desse array aplica o operador de igualdade. Ou seja, sempre que o operador é omitido, é aplicado
o operador de igualdade. Mas é possível adicionar outros operadores utilizando a sintaxe <destak>operador</destak> <destak>:</destak> <destak>valor</destak></p>
<p>Exemplo:</p>
<pre class="code"><code class="language-php">['idade' =&gt; '&gt;=:10']</code></pre>


<p>Os seguintes operadores estão disponíveis</p>
<table>
<thead>
<tr>
<th>Operador</th>
<th>Descrição</th>
<th>Comportamento</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>Igualdade</td>
<td>Filtra o valor exatamente igual</td>
</tr>
<tr>
<td>&gt;</td>
<td>Maior que</td>
<td>Filtra valor maior que</td>
</tr>
<tr>
<td>&gt;=</td>
<td>Maior igual que</td>
<td>Filtra valor maior igual que</td>
</tr>
<tr>
<td>&lt;</td>
<td>Menor que</td>
<td>Filtra valor menor que</td>
</tr>
<tr>
<td>&lt;=</td>
<td>Menor igual que</td>
<td>Filtra valor menor igual que</td>
</tr>
<tr>
<td>&lt;&gt;</td>
<td>Diferente de</td>
<td>Filtra valor diferente de</td>
</tr>
<tr>
<td>%</td>
<td>Contém</td>
<td>Filtra valor contendo uma parte do texto</td>
</tr>
<tr>
<td>in</td>
<td>Entre</td>
<td>Filtra valor dentro de uma lista de valores</td>
</tr>
<tr>
<td>notin</td>
<td>Não entre</td>
<td>Filtra valor que não está dentro de uma lista de valores</td>
</tr>
<tr>
<td>isnull</td>
<td>Nulo</td>
<td>Filtra valor que é nulo</td>
</tr>
<tr>
<td>isnotnull</td>
<td>Não nulo</td>
<td>Filtra valor que não é nulo</td>
</tr>
</tbody>
</table>
<p>Exemplo de uso dos operadores:</p>
<pre class="code"><code class="language-php">  $filter = [
    'idade'    =&gt; '25',   // onde a idade é igual a 25
    'id'       =&gt; '&gt;:10', // id maior que 10
    'numero'   =&gt; '&gt;=30', // número maior igual a 30
    'registro' =&gt; '&lt;20',  // registro menor que 20
    'contador' =&gt; '&lt;=90', // contador menor igual a 90
    'nome'     =&gt; '%joão',// nome contém joão
    'status'   =&gt; 'in:2,3,4', // status entre (2,3,4)
    'pending'  =&gt; 'notin:1,2', // pendind não está entre (1,2)
    'deleted'  =&gt; 'isnull', // deleted é nulo
    'active'   =&gt; 'isnotnull', // active não é nulo
  ]</code></pre>


<h3 id="conexao-de-dados">Conexão de dados<a class="headerlink" href="#conexao-de-dados" title="Permanent link">#</a></h3>
<p>Todo store utiliza o <destak>Doctrine Database Abstraction Layer</destak> <destak>DBAL</destak> para se conectar ao banco 
de dados e executar as operações de consulta e manipulação de registros. </p>
<p>Por padrão, um store utiliza a conexão <destak>default</destak> do <strong>DBAL</strong>. Mas é possível configurar um store para 
utilizar outra conexão, caso mais de uma conexão tenham sido definidas no registro do <destak>DoctrineServiceProvider</destak>.</p>
<p>Para utilizar uma outra conexão, basta definir a propriedade <destak>$conn<destak> do store:</p>
<pre class="code"><code class="language-php">class MeuStore extends Singular\SingularStore
{
   protected $conn = &quot;mssql_leitura&quot;;

   protected $table = &quot;tabela1&quot;;
}</code></pre>


<h3 id="identificador-unico-da-tabela">Identificador único da tabela<a class="headerlink" href="#identificador-unico-da-tabela" title="Permanent link">#</a></h3>
<p>Assim como toda tabela possui uma chave primária, um store também possui um identificador único que representa essa 
chave primária da tabela. Por padrão, um identificador de um store procura pelo campo <destak>id</destak> da tabela. 
Entretanto, esse campo pode ser alterado, caso a chave primária da tabela com a qual você estiver trabalhando não se 
chame id.</p>
<p>Para alterar o nome do campo que representa a chave primária, basta alterar a propriedade <destak>$id</destak> do seu 
store.</p>
<pre class="code"><code class="language-php">class MeuStore extends Singular\SingularStore
{
   protected $table = &quot;tabela1&quot;;

   protected $id = &quot;minhachave&quot;
}</code></pre>


<h3 id="sequences">Sequences<a class="headerlink" href="#sequences" title="Permanent link">#</a></h3>
<p>Alguns gerenciadores de banco de dados, utilizam <destak>sequences</destak> para substituir o recurso de <destak>
autoincrement keys</desak>. </p>
<p>Para trabalhar com sequences no store, basta definir a propriedade <destak>$sequence</destak> do store.</p>
<pre class="code"><code class="language-php">class MeuStore extends Singular\SingularStore
{
   protected $table = &quot;tabela1&quot;;

   protected $sequence = &quot;meustore_sequence&quot;
}</code></pre>


<h3 id="softdelete">SoftDelete<a class="headerlink" href="#softdelete" title="Permanent link">#</a></h3>
<p>2.1</p>
<h3 id="registro-automatico-de-criacao">Registro automático de criação<a class="headerlink" href="#registro-automatico-de-criacao" title="Permanent link">#</a></h3>
<p>2.1</p>
<h3 id="registro-automatico-de-atualizacao">Registro automático de atualização<a class="headerlink" href="#registro-automatico-de-atualizacao" title="Permanent link">#</a></h3>
<p>2.1</p>
<h3 id="perfis-de-consulta">Perfis de consulta<a class="headerlink" href="#perfis-de-consulta" title="Permanent link">#</a></h3>
<p>Todas as funções de consulta herdadas do SingularStore, por padrão, retornam determinados campos, aplicando joins, 
groupings e filtros padrão. Isso é ótimo, pois evita a criação de consultas complexas desnecessárias agilizando o 
processo. Entretanto, pode haver a necessidade de trazer informações diferentes, com filtros e joins diferentes, 
dependendo do contexto. A versão 2 do Singular implementa uma funcionalidade chamada <destak>Perfis de consulta (profiles)</destak>
que permite criar vários perfis de consulta (campos do select, filtros, joins, groupings), dessa forma é possível de 
acordo com o contexto, selecionar um ou outro perfil padrão, eliminando ainda mais a necessidade de criar querys 
complexas para atividades triviais.</p>
<p>Quando você cria um novo store, por padrão ele já define o padrão <destak>default</destak> de consulta:</p>
<pre class="code"><code class="language-php">    ...
    /**
     * Perfis de consulta.
     *
     * @var array
     */
    protected $profiles = [
        'default' =&gt; [
            'select' =&gt; ['t.*'],
            'joins' =&gt; [],
            'filters' =&gt; [],
            'groupings' =&gt; []
        ]
    ];
    ...</code></pre>


<p>Um perfil de consulta nada mais é que um array de arrays estruturados. Para criar um novo perfil, basta criar um 
elemento na propriedade <destak>$profiles</destak> atribuindo-lhe um nome e igualando seu valor a um outro array com as 
propriedades:</p>
<p><destak>select</destak> Array com a lista dos campos que serão selecionadas, por padrão o alias da tabela vinculada ao store é <strong>t</strong><br></p>
<pre class="code"><code class="language-php">    [
        'select'=&gt; ['t.nome','t.id as codigo']
    ]</code></pre>


<p><destak>joins</destak> um array de definição de um relacionamento com outra tabela. Para cada elemento do join é necessário
 definir:</p>
<ul>
<li><strong>Primeiro parâmetro</strong>:<destak>obrigatório</destak> nome da tabela relacionada </li>
<li><strong>Segundo parâmetro</strong>:<destak>obrigatório</destak> o alias da nova tabela</li>
<li><strong>Terceiro parâmetro</strong>:<destak>obrigatório</destak>  a condição de igualdade do relacionamento </li>
<li><strong>Quarto parâmetro</strong>: <destak>opcional</destak> o tipo de relacionamento (left ou join), se for omitido assume o valor 'join'.</li>
</ul>
<pre class="code"><code class="language-php">[
   'joins' =&gt; [
      ['perfil','p','p.id = u.perfil_id', 'left']
   ]
]</code></pre>


<p><destak>filters</destak> um array de definição dos filtros padrão a serem aplicados na consulta.</p>
<pre class="code"><code class="language-php">[
   'filters' =&gt; [
      'ativo' =&gt; '1'
   ]
]</code></pre>


<p><destak>groupings</destak> um array de definição dos agrupamentos padrão aplicados na consulta</p>
<pre class="code"><code class="language-php">[
   'grouping' =&gt; [
      't.id'
   ]
]</code></pre>


<p>Para fazer uma consulta utilizando um perfil de consulta, basta acionar o método <destak>setProfile</destak> antes de
 executar uma das funções (find, findBy, findOneBy).</p>
<pre class="code"><code class="language-php">$app['cadastro.store.usuario']-&gt;setProfile('perfil')-&gt;findBy(['id' =&gt; '&gt;:10']);</code></pre>


<h3 id="criando-consultas-customizadas">Criando consultas customizadas<a class="headerlink" href="#criando-consultas-customizadas" title="Permanent link">#</a></h3>
<p>Embora os métodos <destak>findBy</destak> e <destak>findOneBy</destak> possam ser muito úteis e flexíveis através da 
utilização dos perfis de consulta, algumas vezes se faz necessário criar consultas customizadas e complexas para 
realizar tarefas específicas. Esses métodos podem ser facilmente criados nas classes store. </p>
<p>A classe store, possui uma propriedade <destak>$db</destak> que fornece acesso à classe de conexão <destak>DBAL</destak>
 do Doctrine para o Silex. Para facilitar a criação de consultas, e ter consultas que sejam mais legíveis, é 
 extremamente importante utilizar o <destak>QueryBuilder</destak> do Doctrine. Para recuperar uma nova instância do 
 query builder, basta:</p>
<pre class="code"><code class="language-php">$qb = $this-&gt;db-&gt;createQueryBuilder();</code></pre>


<p>Ao criar uma consulta customizada, geralmente, precisamos passar filtros para essa consulta. Por questões de segurança,
 <strong>SEMPRE</strong> utilize a vinculação de parâmetros para definir filtros. <strong>NÃO UTILIZE</strong> a vinculação da entrada do usuário
diretamente na montagem da sua consulta. Vamos ver uma aplicação de certo e errado:</p>
<pre class="code"><code class="language-php">/* ERRADO */
$qb-&gt;select('u.*')
   -&gt;from('usuarios','u')
   -&gt;where('u.idade &gt; '.$idade);
$rs = $this-&gt;db-&gt;fetchAll($qb-&gt;getSQL());

/* CORRETO */
$qb-&gt;select('u.*')
   -&gt;from('usuarios','u')
   -&gt;where('u.idade &gt; :idade');

$rs = $this-&gt;db-&gt;fetchAll($qb-&gt;getSQL(), ['idade' =&gt; $idade]);</code></pre>
          <aside class="copyright" role="note">
            
              Copyright (c) 2018 Net On Soluções &ndash;
            
            Documentação gerada pelo
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../singularcli/" title="Singular Cli">
          <span class="direction">
            Voltar
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Singular Cli
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../frontend/" title="Frontend">
          <span class="direction">
            Proximo
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Frontend
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = '';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
    
  </body>
</html>